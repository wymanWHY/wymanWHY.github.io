---
title: LVS概要
date: 2018-02-27 11:49:06
tags:
---
# LVS 的组成

>**由于 LVS 只是对 IP 进行处理，对数据包的内容并不关心，所以称为基于 IP 的负载均衡技术。**

三个层次：

- 负载调度器层（load balancer）：它是整个集群对外面的前端机，负责将客户端的请求发送到一组后端服务器上执行，负载调度层通常由一台或者多台负载调度器(Director Server)组成，LVS 模块需要安装在每个负载调度器上。
- 服务器池层（Server pool）：是一组真正处理客户请求的服务器，执行的服务为 WEB、MAIL、FTP 和 DNS 等。每个真实服务器(Real Server)之前通过高速的 LAN 或分布在各地的 WAL 相连接。
- 数据共享储存层(Share Storage)：它为服务器池提供一个共享的存储区，这样容易使得服务器池中的主机拥有相同的信息与配置，从而便于共同提供服务。


# LVS的实现

IP 负载均衡技术分为三种：

- 通过 NAT 实现虚拟服务器（VS/NAT）

- 通过 IP 隧道实现虚拟服务器（VS/TUN）

- 通过直接路由实现虚拟服务器（VS/DR）

## 1、通过 NAT 实现虚拟服务器（VS/NAT）

### 主要工作流程：

- 当用户通过虚拟 IP 地址（VIP，可通过公网访问）访问网络服务时，请求到达调度器，调度器将根据调度算法动态的从后端服务器池中选取一台真实服务器（Real Server）负责响应，同时调度器将请求报文的目标地址（VIP）改写为 Real Server 的 IP 地址，将报文的目标端口改写为 Real Server 相应的端口，最后将报文发送给选定的 Real Server，同时调度器在连接 Hash 表中记录这个连接记录。
- Real Server 收到数据并处理数据后，将响应的报文发送给调度器，调度器根据连接 Hash 表中的记录，将响应报文的源 IP 地址和源端口改写为虚拟IP（VIP）和调度器的相应端口。
- 最后，调度器将响应数据发送给用户，完成这个负载均衡过程。

在 NAT 模式下，用户请求和响应报文都会经过负载调度器，并且被修改 IP 地址和端口。整个过程中，用户只能看到是 VIP 所在服务器提供的服务，而后端服务器集群结构对用户是透明的。

### 缺点

**所有进出的报文都要经过负载均衡器（Director Server），当用户请求很多时，调度器的处理能力将会成为整个系统的瓶颈。一般支持的真实服务器数目在 10 台至 20 台左右。**

## 2、通过直接路由实现虚拟服务器（VS/DR）

VS/DR（Virtual Server via Direct Routing）利用大多数 Internet 服务的非对称特点，负载调度器中只负责调度请求，而服务器直接将响应返回给客户，可以极大地提高整个集群系统的吞吐量：

- 1、客户端通过 Internet 向服务器发起请求，而请求的 IP 地址指向的是调度器上对外公布的 IP 地址；
- 2、请求报文到达调度器（Load Balancer），调度器根据各个服务器的负载情况，动态地选择一台服务器，不修改也不封装 IP 报文，而是将数据帧的 MAC 地址改为选出服务器的 MAC 地址，再将修改后 的数据帧在与服务器组的局域网上发送。因为数据帧的 MAC 地址是选出的服务器，所以服务器肯定可以收到这个数据帧；
- 3、Real Server 接收到报文之后，发现报文的目标地址 VIP 是在本地的网络设备上，服务器处理这个报文，然后根据路由表将响应报文直接返回给客户。

### 特点：

- 集群节点，也就是 Real Server 与 Load Balacer 必须在同一个物理网络中；
- RIP 通常是私有地址，也可以是公网地址，以便于远程管理与监控；
- Load Balancer 仅仅负责处理入站的请求，Real Server 将直接响应客户端；
- 不支持端口映射：也就是Real Server 的端口必须是与 Load Balancer 对外服务的一样；


## 3、通过 IP 隧道实现虚拟服务器（VS/TUN）
IP隧道（IP tunneling）是将一个 IP 报文封装在另一个 IP 报文的技术，这可以使得目标为一个 IP 地址的数据报文能被封装和转发到另一个 IP 地址。IP 隧道技术亦称为 IP 封装技术（IP encapsulation）。IP 隧道主要用于移动主机和虚拟私有网络（Virtual Private Network），在其中隧道都是静态建立的，隧道一端有一个 IP 地址，另一端也有唯一的 IP 地址。



